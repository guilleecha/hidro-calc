{% extends "base.html" %}
{% load static %}

{% block title %}HidroStudio - {{ project.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'studio/css/studio.css' %}">
{% endblock %}

{% block content %}
<div class="studio-layout">
    <!-- Sidebar -->
    <aside class="studio-sidebar">
        <div class="sidebar-section">
            <h3>ğŸ“ Proyectos</h3>
            <ul class="tree-view">
                {% for proj in all_projects %}
                <li>
                    <a href="{% url 'studio:dashboard_project' proj.id %}"
                       class="tree-item {% if proj.id == project.id %}active{% endif %}">
                        {{ proj.name }}
                    </a>
                    {% if proj.id == project.id and watersheds %}
                    <ul class="sub-tree">
                        {% for ws in watersheds %}
                        <li>
                            <a href="?watershed={{ ws.id }}"
                               class="tree-item {% if ws.id == selected_watershed.id %}active{% endif %}">
                                ğŸ’§ {{ ws.name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </li>
                {% empty %}
                <li class="tree-item">No hay proyectos</li>
                {% endfor %}
            </ul>
        </div>

        {% if selected_watershed %}
        <div class="sidebar-section">
            <h3>ğŸ“Š AnÃ¡lisis</h3>
            <ul class="menu-list">
                <li>
                    <a href="#" class="tree-item">
                        ğŸŒ§ï¸ Tormentas ({{ design_storms.count }})
                    </a>
                </li>
                <li>
                    <a href="#" class="tree-item">
                        ğŸ“ˆ Hidrogramas ({{ hydrographs.count }})
                    </a>
                </li>
                <li>
                    <a href="{% url 'studio:hydrograph_compare' project.id %}" class="tree-item">
                        ğŸ“Š Comparar MÃ©todos
                    </a>
                </li>
            </ul>
        </div>
        {% endif %}
    </aside>

    <!-- Main Content -->
    <main class="studio-main">
        {% if not project %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‚</div>
            <h2>No hay proyectos disponibles</h2>
            <p>Crea un proyecto desde el <a href="/admin/">Django Admin</a> para comenzar.</p>
        </div>
        {% elif not selected_watershed %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ’§</div>
            <h2>No hay cuencas en este proyecto</h2>
            <p>Crea una nueva cuenca para comenzar a analizar datos hidrolÃ³gicos.</p>
            <a href="{% url 'studio:watershed_create' project.id %}" class="empty-state-button">
                + Crear Cuenca
            </a>
        </div>
        {% else %}
        <!-- Header -->
        <div class="studio-header">
            <h1>{{ project.name }}</h1>
            <div class="breadcrumb">
                {{ project.name }} / {{ selected_watershed.name }}
            </div>
        </div>

        <!-- Stats Cards -->
        {% if stats %}
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ’§</div>
                <div class="stat-value">{{ stats.peak_discharge_max|floatformat:2 }}</div>
                <div class="stat-label">Caudal MÃ¡x (mÂ³/s)</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-value">{{ stats.total_hydrographs }}</div>
                <div class="stat-label">Hidrogramas Calculados</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸŒ§ï¸</div>
                <div class="stat-value">{{ design_storms.count }}</div>
                <div class="stat-label">Tormentas de DiseÃ±o</div>
            </div>
        </div>
        {% endif %}

        <!-- Watershed Info -->
        <div class="info-card">
            <h2>ğŸ’§ InformaciÃ³n de la Cuenca</h2>
            <div class="info-row">
                <span class="info-label">Ãrea:</span>
                <span class="info-value">{{ selected_watershed.area_hectareas }} ha ({{ selected_watershed.area_m2|floatformat:0 }} mÂ²)</span>
            </div>
            <div class="info-row">
                <span class="info-label">Tiempo de ConcentraciÃ³n:</span>
                <span class="info-value">{{ selected_watershed.tc_horas }} h ({{ selected_watershed.tc_minutes|floatformat:0 }} min)</span>
            </div>
            {% if selected_watershed.nc_scs %}
            <div class="info-row">
                <span class="info-label">NÃºmero de Curva (NC):</span>
                <span class="info-value">{{ selected_watershed.nc_scs }}</span>
            </div>
            {% endif %}
            {% if selected_watershed.c_racional %}
            <div class="info-row">
                <span class="info-label">Coeficiente Racional (C):</span>
                <span class="info-value">{{ selected_watershed.c_racional }}</span>
            </div>
            {% endif %}
            {% if selected_watershed.elevation_m %}
            <div class="info-row">
                <span class="info-label">ElevaciÃ³n:</span>
                <span class="info-value">{{ selected_watershed.elevation_m }} msnm</span>
            </div>
            {% endif %}
        </div>

        <!-- Storm Info -->
        {% if latest_storm %}
        <div class="info-card">
            <h2>ğŸŒ§ï¸ Ãšltima Tormenta de DiseÃ±o</h2>
            <div class="info-row">
                <span class="info-label">Nombre:</span>
                <span class="info-value">{{ latest_storm.name }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">PerÃ­odo de Retorno:</span>
                <span class="info-value">{{ latest_storm.return_period_years }} aÃ±os</span>
            </div>
            <div class="info-row">
                <span class="info-label">DuraciÃ³n:</span>
                <span class="info-value">{{ latest_storm.duration_hours }} h</span>
            </div>
            <div class="info-row">
                <span class="info-label">Lluvia Total:</span>
                <span class="info-value">{{ latest_storm.total_rainfall_mm }} mm</span>
            </div>
            <div class="info-row">
                <span class="info-label">DistribuciÃ³n:</span>
                <span class="info-value">{{ latest_storm.get_distribution_type_display }}</span>
            </div>
        </div>
        {% endif %}

        <!-- Charts -->
        {% if hyetograph_data %}
        <div class="chart-container">
            <div id="hyetograph-chart" style="width:100%; height:400px;"></div>
        </div>
        {% endif %}

        {% if hydrographs_data %}
        <div class="chart-container">
            <div id="hydrographs-chart" style="width:100%; height:400px;"></div>
        </div>
        {% endif %}

        {% endif %}
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/plotly-charts.js"></script>
<script src="/static/js/dashboard-charts.js"></script>

<!-- Data injection for charts -->
<script>
    {% if hyetograph_data %}
    window.hyetographData = {{ hyetograph_data|safe }};
    window.hyetographData.title = 'ğŸ“Š Hietograma - {{ latest_storm.name }}';
    {% endif %}

    {% if hydrographs_data %}
    window.hydrographsData = {{ hydrographs_data|safe }};
    window.hydrographsTitle = 'ğŸ“ˆ ComparaciÃ³n de Hidrogramas ({{ hydrographs.count }} mÃ©todos)';
    {% endif %}
</script>
{% endblock %}
